{% extends "base.html" %}
{% block title %}Agency Dashboard | TrippyPick{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    .dashboard-nav { border-bottom: 1px solid #dee2e6; margin-bottom: 2rem; }
    .dashboard-nav .nav-link { color: #6c757d; border: none; padding: 0.8rem 1.2rem; }
    .dashboard-nav .nav-link.active { color: #000; font-weight: 600; border-bottom: 2px solid #000; }
    .status-card { background-color: #f8f9fa; border: 1px solid #e9ecef; padding: 2rem; border-radius: 0.5rem; }
    hr { margin: 3rem 0; }
    .itinerary-day-form { border: 1px solid #e9ecef; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem; }
  </style>
{% endblock %}

{% block content %}
<div class="container py-5" data-package-submitted="{{ package_submitted }}">
  
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Welcome, {{ session.agency_name }}</h1>
    <a href="{{ url_for('agency_logout') }}" class="btn btn-outline-dark">Logout</a>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} mb-3" role="alert">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <ul class="nav nav-tabs dashboard-nav" id="agencyTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">Dashboard</button>
    </li>
    {% if submission.approved %}
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="add-package-tab" data-bs-toggle="tab" data-bs-target="#add-package" type="button" role="tab">Add Package</button>
    </li>
    {% endif %}
  </ul>

  <div class="tab-content" id="agencyTabContent">
    
    <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
      <h3>Your Application Status</h3>
      <div class="status-card">
        <p><strong>Approval Status:</strong> 
          {% if submission.approved %}
            <span class="badge bg-success">Approved</span>
            <p class="mt-3">Congratulations! Your agency has been verified. You can now proceed to the "Add Package" tab to submit your travel packages for review.</p>
          {% else %}
            <span class="badge bg-warning text-dark">Pending Admin Approval</span>
            <p class="mt-3 text-muted">Your application is awaiting review by an administrator. You will be notified once it is approved.</p>
          {% endif %}
        </p>
        <p><strong>Listing Status:</strong> <span class="text-capitalize">{{ submission.status | replace("_", " ") }}</span></p>
      </div>
    </div>

    {% if submission.approved %}
    <div class="tab-pane fade" id="add-package" role="tabpanel">
      
      {% if not package_submitted %}
        
        <h3>Step 1: Submit a New Package</h3>
        <form method="POST" action="{{ url_for('add_package') }}" enctype="multipart/form-data">
          <div class="row">
            <div class="col-md-6 mb-3"><label for="package_name" class="form-label">Package Name</label><input type="text" class="form-control" id="package_name" name="package_name" required></div>
            <div class="col-md-6 mb-3"><label for="destination" class="form-label">Destination</label><input type="text" class="form-control" id="destination" name="destination" required></div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3"><label for="cost_per_package" class="form-label">Cost per Package (â‚¹)</label><input type="number" class="form-control" id="cost_per_package" name="cost_per_package" required></div>
            <div class="col-md-4 mb-3"><label for="days" class="form-label">Days</label><input type="number" class="form-control" id="days" name="days" required></div>
            <div class="col-md-4 mb-3"><label for="nights" class="form-label">Nights</label><input type="number" class="form-control" id="nights" name="nights" required></div>
          </div>
          <div class="mb-3"><label for="group_size" class="form-label">Max Group Size</label><input type="number" class="form-control" id="group_size" name="group_size" required></div>
          <div class="mb-3"><label for="description" class="form-label">Description</label><textarea class="form-control" id="description" name="description" rows="3" required></textarea></div>
          <div class="mb-3"><label for="highlights" class="form-label">Highlights (comma-separated)</label><input type="text" class="form-control" id="highlights" name="highlights" required></div>
          <div class="mb-3"><label for="inclusions_detailed" class="form-label">Inclusions (comma-separated)</label><input type="text" class="form-control" id="inclusions_detailed" name="inclusions_detailed" required></div>
          <div class="mb-3"><label for="exclusions_detailed" class="form-label">Exclusions (comma-separated)</label><input type="text" class="form-control" id="exclusions_detailed" name="exclusions_detailed" required></div>
          <div class="mb-3"><label for="destination_img" class="form-label">Upload Image</label><input class="form-control" type="file" id="destination_img" name="destination_img" accept="image/*" required></div>
          <button type="submit" class="btn btn-dark">Submit Package for Review</button>
        </form>

      {% else %}

        <h3>Step 2: Add Itinerary for '{{ new_pkg_name }}'</h3>
        <form method="POST" action="{{ url_for('add_itinerary') }}">
          <input type="hidden" name="package_name" value="{{ new_pkg_name }}">
          <input type="hidden" name="num_days" value="{{ days_for_itinerary }}">
          
          {% for day_num in range(1, days_for_itinerary + 1) %}
          <div class="itinerary-day-form">
            <h5>Day {{ day_num }}</h5>
            <div class="mb-3">
              <label for="title_{{ day_num }}" class="form-label">Day Title</label>
              <input type="text" class="form-control" id="title_{{ day_num }}" name="title_{{ day_num }}" placeholder="e.g., Arrival in Goa" required>
            </div>
            <div class="mb-3">
              <label for="description_{{ day_num }}" class="form-label">Day Description</label>
              <textarea class="form-control" id="description_{{ day_num }}" name="description_{{ day_num }}" rows="2" required></textarea>
            </div>
          </div>
          {% endfor %}

          <button type="submit" class="btn btn-secondary mt-3">Submit Full Itinerary</button>
        </form>
        <hr>
        <a href="{{ url_for('agency_dashboard') }}" class="btn btn-outline-dark">Add Another Package</a>

      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<script src="{{ url_for('static', filename='js/agency.js') }}"></script>
{% endblock %}
