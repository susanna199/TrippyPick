{% extends "base.html" %}
{% block title %}Agency Dashboard | TrippyPick{% endblock %}

{% block head %}
  {{ super() }}
  <style>
    .dashboard-nav { border-bottom: 1px solid #dee2e6; margin-bottom: 2rem; }
    .dashboard-nav .nav-link.active { font-weight: 600; }
    .status-card { background-color: #f8f9fa; border: 1px solid #e9ecef; padding: 2rem; border-radius: 0.5rem; }
    .dashboard-section-title { margin-top: 2.5rem; }
    .table { font-size: 0.9rem; }
  </style>
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Welcome, {{ session.agency_name }}</h1>
    <a href="{{ url_for('agency_logout') }}" class="btn btn-outline-dark">Logout</a>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show mb-3" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <ul class="nav nav-tabs dashboard-nav" id="agencyTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#dashboard" type="button">Dashboard</button>
    </li>
    {% if submission.approved %}
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-packages" type="button">View Packages</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" data-bs-toggle="tab" data-bs-target="#view-itineraries" type="button">View Itineraries</button>
    </li>
    {% endif %}
  </ul>

  <div class="tab-content">
    <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
      <h3 class="dashboard-section-title">Your Application Status</h3>
      <div class="status-card">
        <p><strong>Approval Status:</strong> 
          {% if submission.approved %}
            <span class="badge bg-success">Approved</span>
            <p class="mt-3">Congratulations! You can now view and add packages.</p>
          {% else %}
            <span class="badge bg-warning text-dark">Pending Admin Approval</span>
          {% endif %}
        </p>
      </div>
    </div>

    {% if submission.approved %}
    <div class="tab-pane fade" id="view-packages" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center">
        <h3 class="dashboard-section-title">Your Submitted Packages</h3>
        <a href="{{ url_for('add_package') }}" class="btn btn-primary">Add New Package</a>
      </div>
      <div class="table-responsive mt-3">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Package Name</th>
              <th>Destination</th>
              <th>Cost (â‚¹)</th>
              <th>Days</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for pkg in package_submissions %}
            <tr>
              <td>{{ pkg.package_name }}</td>
              <td>{{ pkg.destination }}</td>
              <td>{{ "{:,.0f}".format(pkg.cost_per_package) }}</td>
              <td>{{ pkg.days }}</td>
              <td><a href="{{ url_for('edit_package', submission_id=pkg.id) }}" class="btn btn-sm btn-outline-secondary">Edit</a></td>
            </tr>
            {% else %}
            <tr><td colspan="5" class="text-center">You have not submitted any packages yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="tab-pane fade" id="view-itineraries" role="tabpanel">
       <h3 class="dashboard-section-title">Your Submitted Itineraries</h3>
       <div class="table-responsive mt-3">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Package Name</th>
              <th>Day</th>
              <th>Title</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for item in itinerary_submissions %}
            <tr>
              <td>{{ package_names_by_id[item.package_submissions_id] }}</td>
              <td>{{ item.day_no }}</td>
              <td>{{ item.title }}</td>
              {# --- THIS LINK IS NOW CORRECTED --- #}
              <td><a href="{{ url_for('edit_itinerary', itinerary_id=item.id) }}" class="btn btn-sm btn-outline-secondary">Edit</a></td>
            </tr>
            {% else %}
            <tr><td colspan="4" class="text-center">No itinerary details submitted.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}
